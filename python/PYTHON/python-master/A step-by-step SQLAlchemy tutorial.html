
<!-- saved from url=(0054)http://www.rmunn.com/sqlalchemy-tutorial/tutorial.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><title>A step-by-step SQLAlchemy tutorial</title>
<link href="./A step-by-step SQLAlchemy tutorial_files/style.css" rel="stylesheet">
<link href="./A step-by-step SQLAlchemy tutorial_files/syntaxhighlight.css" rel="stylesheet">
</head>
<body><h1>A step-by-step SQLAlchemy tutorial</h1>

<h2>About This Tutorial</h2>

<p>This tutorial is for SQLAlchemy version 0.2. You may notice that some sections
are marked "<strong>New in 0.2</strong>". If this is the first time you're reading this
tutorial, you can safely skip those sections. On the other hand, if you read
the <a href="http://www.rmunn.com/sqlalchemy-tutorial/tutorial-0.1.html">previous version of this tutorial</a> and are now trying to learn
SQLAlchemy 0.2, then just search for the text "<strong>New in 0.2</strong>" and you'll have
a lot less reading to do this time around. (Do make sure to update all the
demo code, though: every single file of the demo code has changed, and you'll
get errors if you try to run the old demo code under SQLAlchemy 0.2).</p>

<p>If you're using SQLAlchemy version 0.3, don't worry — everything you'll 
learn in this tutorial still works just fine under SQLAlchemy 0.3. Nearly all
the changes to SQLAlchemy between 0.2 and 0.3 were either internal code cleanups,
or else were changes to advanced features that this tutorial doesn't cover.
Therefore, I probably won't give this tutorial a rewrite for SQLAlchemy 0.3.</p>

<p>Now, on with the tutorial.</p>

<h2>Getting Started</h2>

<p>Before we install SQLAlchemy, let's make sure you have the latest version of
setuptools, which can make your life a lot easier. At a command prompt, run:</p>

<pre><code><span class="python_name">easy_install </span><span class="python_operator">--</span><span class="python_name">help</span><span class="python_operator">
</span></code></pre>

<p>If you get a list of commands and options, great: setuptools is installed and
working on your system, and you can skip to the next paragraph. If you get an
error message like "command not found", then you'll need to install
setuptools. Download <a href="http://peak.telecommunity.com/dist/ez_setup.py">ez_setup.py</a> and run it. (If you're on Linux or OS X,
you may need to run it as root by doing "<code>sudo python ez_setup.py</code>").</p>

<p>Now that you have setuptools installed, you can install SQLAlchemy by running:</p>

<pre><code><span class="python_name">easy_install SQLAlchemy</span><span class="python_operator">
</span></code></pre>

<p>On Linux and OS X, you may need to run this as root ("<code>sudo easy_install
SQLAlchemy</code>"). This will automatically connect to the <a href="http://cheeseshop.python.org/pypi">Python Package Index</a>,
find the latest version of SQLAlchemy, download it, and set it up in your
site-packages directory.</p>

<p>You'll also need the latest version of pysqlite installed. Run "<code>easy_install
pysqlite</code>" (with <code>sudo</code> if necessary) to fetch it. On Windows, that's all you
need; on Mac OS X or Linux, you'll also need the sqlite3 package installed.
The exact details of installing a package will vary from system to system:
just make sure it's sqlite3 you're installing, and not sqlite or sqlite2.</p>

<p>Once you have everything installed, you're ready to begin!</p>

<h2>First Steps</h2>

<p>Let's start with a simple SQLAlchemy program. Copy this into a text editor and
save it as "<code>firststeps.py</code>":</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///tutorial.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">db</span><span class="python_operator">.</span><span class="python_name">echo </span><span class="python_operator">= </span><span class="python_name">False  </span><span class="python_comment"># Try changing this to True and see what happens</span><span class="python_operator">
</span>
<span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">40</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'age'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">create</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">i </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">insert</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'Mary'</span><span class="python_operator">, </span><span class="python_name">age</span><span class="python_operator">=</span><span class="python_number">30</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_operator">=</span><span class="python_literal">'secret'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">({</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'John'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">42</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
          <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Susan'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">57</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
          <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Carl'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">33</span><span class="python_enclosure">})</span><span class="python_operator">
</span>
<span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">rs </span><span class="python_operator">= </span><span class="python_name">s</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">row </span><span class="python_operator">= </span><span class="python_name">rs</span><span class="python_operator">.</span><span class="python_name">fetchone</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Id:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Name:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_enclosure">[</span><span class="python_literal">'name'</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Age:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">age</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Password:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_enclosure">[</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">password</span><span class="python_enclosure">]</span><span class="python_operator">
</span>
<span class="python_keyword">for </span><span class="python_name">row </span><span class="python_keyword">in </span><span class="python_name">rs</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_literal">'is'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">age</span><span class="python_operator">, </span><span class="python_literal">'years old'</span><span class="python_operator">
</span></code></pre>

<h2>First Steps, in detail</h2>

<p>This code sample shows off a lot of the features of SQLAlchemy. Let's go
through it step-by-step.</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///tutorial.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>The first step in writing SQLAlchemy code is to open a connection to the
database you'll be using. In SQLAlchemy, this is done by creating an
<code>SQLEngine</code> object, which knows how to talk to one particular type of database
(SQLite, PostgreSQL, Firebird, MySQL, Oracle...). The <code>SQLEngine</code> object also
doubles as a connection object. Behind the scenes, it will create a pool of
database connections and re-use them automatically as needed, to keep your
application running quickly. But most of the time, you don't even need to
think about the database connections; just use the <code>SQLEngine</code> object that
<code>create_engine()</code> returns, and let SQLAlchemy handle the details for you.</p>

<p><strong>New in 0.2</strong>: In SQLAlchemy 0.1, the syntax of <code>create_engine()</code> calls would
depend on which database engine you were using, and wasn't very userfriendly.
Now it's much more consistent. No matter what database you're using, the
<code>create_engine()</code> function takes a single parameter that's a URI, of the form
"<code>engine://user:password@host:port/database</code>". Most of these options can be
omitted; for example, if you're connecting to a PostgreSQL database on the
default PostgreSQL port (port 5432), the URI would be something like
"<code>postgres://scott:tiger@localhost/demodb</code>". SQLite lets you omit everything
but the filename, so opening a file named <code>tutorial.db</code> in the current
directory becomes "<code>sqlite:///tutorial.db</code>". Or, to open the file
"<code>/tmp/tutorial/joindemo.db</code>", the URI becomes
"<code>sqlite:////tmp/tutorial/joindemo.db</code>". (Yes, that's four slashes in a row.
Two before the (empty) hostname section, then one before the database section,
and one final slash at the start of the path "<code>/tmp/tutorial/joindemo.db</code>".)</p>

<pre><code><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>Before creating our Table definitions, we need to create the object that will
manage them. Table definitions (what the columns are called, what their data
types are) are an example of "metadata" -- information about your data. So the
object that manages this collection of metadata is called a <code>MetaData</code> object.
There are two varietes, <code>BoundMetaData</code> which is tied to a specific database
connection, or <code>DynamicMetaData</code> which can be created before the database
connection has been established.</p>

<p>If you don't know why you'd want to use <code>DynamicMetaData</code>, or if you didn't
really understand the previous paragraph, don't worry about it. Just remember
that you'll need a <code>BoundMetaData</code> to keep your <code>Table</code> objects in, and move
on to the rest of the tutorial.</p>

<p><strong>New in 0.2</strong>: In SQLAlchemy 0.1, you'd pass the <code>db</code> object to your
<code>Table</code>s; and, in fact, this is still allowed; it will automatically create a
<code>BoundMetaData</code> object for you. It's better to create the <code>BoundMetaData</code>
object explicitly, though, because that makes it a lot easier to do operations
like <code>metadata.create_all()</code> to create all your tables at once.</p>

<pre><code><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">40</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'age'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">create</span><span class="python_enclosure">()</span><span class="python_operator">
</span></code></pre>

<p>This should be pretty self-explanatory: we've just created a <code>users</code> table
in our database, with four columns. If the <code>users</code> table already existed, we
could instead have done:</p>

<pre><code><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>and SQLAlchemy would have automatically figured out the table's structure from
the database.</p>

<pre><code><span class="python_name">i </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">insert</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'Mary'</span><span class="python_operator">, </span><span class="python_name">age</span><span class="python_operator">=</span><span class="python_number">30</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_operator">=</span><span class="python_literal">'secret'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">({</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'John'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">42</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
          <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Susan'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">57</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
          <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Carl'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">33</span><span class="python_enclosure">})</span><span class="python_operator">
</span></code></pre>

<p>SQLAlchemy's SQL construction methods are beautiful. You'll almost never need
to write SQL by hand. Instead, you create an "SQL statement object", build the
SQL query you want, and call its <code>execute()</code> method. Here we ask for an
<code>INSERT</code> statement referencing the <code>users</code> table:</p>

<pre><code><span class="python_name">i </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">insert</span><span class="python_enclosure">()</span><span class="python_operator">
</span></code></pre>

<p>Now when we do <code>i.execute()</code>, SQLAlchemy will generate the appropriate "<code>INSERT
INTO users VALUES (...)</code>" statement for the values we pass into <code>execute()</code>.
Notice the two different ways of executing an <code>INSERT</code> statement. We can
either pass it keyword parameters, to insert a single object:</p>

<pre><code><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'Mary'</span><span class="python_operator">, </span><span class="python_name">age</span><span class="python_operator">=</span><span class="python_number">30</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_operator">=</span><span class="python_literal">'secret'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>or else we can pass it multiple dictionaries, to insert multiple objects:</p>

<pre><code><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">({</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'John'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">42</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
          <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Susan'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">57</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
          <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Carl'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">33</span><span class="python_enclosure">})</span><span class="python_operator">
</span></code></pre>

<p>If you have any "special" characters (such as semicolons or apostrophes) in
your data, they will be automatically quoted for you by the SQLEngine object,
so you don't have to worry about quoting. This also means that unless you
deliberately bypass SQLAlchemy's quoting mechanisms, SQL-injection attacks are
basically impossible.</p>

<p>You may have also noticed that we didn't have to specify all the columns of
the database. Any columns we didn't specify will get filled with <code>NULL</code>,
except for the primary key, which will automatically get a unique value.</p>

<pre><code><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">rs </span><span class="python_operator">= </span><span class="python_name">s</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">()</span><span class="python_operator">
</span></code></pre>

<p>Like <code>INSERT</code> statements, <code>SELECT</code> statements are also done by creating a
statement object and calling its <code>execute()</code> method. This particular statement
is the basic "<code>SELECT * FROM users</code>" with no <code>WHERE</code> clause. Later on we'll
see how to do <code>WHERE</code> clauses, or only return data from certain columns, or
<code>JOIN</code> two (or more) tables together.</p>

<p>Calling <code>execute()</code> on a <code>SELECT</code> statement object will return a result set,
which has <code>fetchone()</code> and <code>fetchall()</code> methods. As you'd expect, <code>fetchone()</code>
returns a single row, while <code>fetchall()</code> returns a list of rows. The rows
returned aren't simple tuples or dictionaries, but intelligent row objects, as
can be seen below:</p>

<pre><code><span class="python_name">row </span><span class="python_operator">= </span><span class="python_name">rs</span><span class="python_operator">.</span><span class="python_name">fetchone</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Id:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Name:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_enclosure">[</span><span class="python_literal">'name'</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Age:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">age</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">'Password:'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_enclosure">[</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">password</span><span class="python_enclosure">]</span><span class="python_operator">
</span></code></pre>

<p>Here we see some of the various ways you can access the data in a row object.
First, you can pretend it's a tuple and access its columns by position.
SQLAlchemy guarantees that the column order returned from a "<code>SELECT * FROM
(table)</code>" statement will be the same as the order in which the columns were
declared in that table, so here we know that <code>row[0]</code> will be the <code>user_id</code>
column. We can also access the row as if it were a dictionary (<code>row['name']</code>).
Next, my favorite: SQLAlchemy lets us access the columns as if they were
attributes of the row object. (Some simple <code>__getattr__()</code> magic behind the
scenes makes this work). And finally, we can even use the actual <code>Column</code>
objects themselves as keys to lookup results from a row. You probably won't
use this very often, but it can be extremely useful in some circumstances.</p>

<pre><code><span class="python_keyword">for </span><span class="python_name">row </span><span class="python_keyword">in </span><span class="python_name">rs</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_literal">'is'</span><span class="python_operator">, </span><span class="python_name">row</span><span class="python_operator">.</span><span class="python_name">age</span><span class="python_operator">, </span><span class="python_literal">'years old'</span><span class="python_operator">
</span></code></pre>

<p>Finally, we see that we can also iterate through the result set via a simple
<code>for</code> loop. This is especially useful when you expect your <code>SELECT</code> query to
return a huge result set that would be too large to load into memory: the
<code>for</code> loop will only fetch one row at a time from the database.</p>

<h2>Select Statements</h2>

<p>Now let's take a little time to examine some of the various ways in which we
can select rows from our database. There are lots of conditions you might want
to put in the <code>WHERE</code> clause of a <code>SELECT</code> statement, and SQLAlchemy makes
most of those easy.</p>

<p>Copy the following code into "<code>selectdemo.py</code>":</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_comment"># Let's re-use the same database as before
</span><span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///tutorial.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">db</span><span class="python_operator">.</span><span class="python_name">echo </span><span class="python_operator">= </span><span class="python_name">True  </span><span class="python_comment"># We want to see the SQL we're creating</span><span class="python_operator">
</span>
<span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># The users table already exists, so no need to redefine it. Just
# load it from the database using the "autoload" feature.
</span><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_keyword">def </span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">stmt</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_name">rs </span><span class="python_operator">= </span><span class="python_name">stmt</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_keyword">for </span><span class="python_name">row </span><span class="python_keyword">in </span><span class="python_name">rs</span><span class="python_operator">:
        </span><span class="python_keyword">print </span><span class="python_name">row</span><span class="python_operator">
</span>
<span class="python_comment"># Most WHERE clauses can be constructed via normal comparisons
</span><span class="python_operator"><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'John'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># Python keywords like "and", "or", and "not" can't be overloaded, so
# SQLAlchemy uses functions instead
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">and_</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">or_</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">not_</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'Susan'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># Or you could use &amp;, | and ~ -- but watch out for priority!
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">((</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40</span><span class="python_enclosure">) </span><span class="python_operator">&amp; </span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">((</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40</span><span class="python_enclosure">) </span><span class="python_operator">| </span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_operator">~</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'Susan'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># There's other functions too, such as "like", "startswith", "endswith"
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">startswith</span><span class="python_enclosure">(</span><span class="python_literal">'M'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">like</span><span class="python_enclosure">(</span><span class="python_literal">'%a%'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">endswith</span><span class="python_enclosure">(</span><span class="python_literal">'n'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># The "in" and "between" operations are also available
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age</span><span class="python_operator">.</span><span class="python_name">between</span><span class="python_enclosure">(</span><span class="python_number">30</span><span class="python_operator">,</span><span class="python_number">39</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_comment"># Extra underscore after "in" to avoid conflict with Python keyword
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">.</span><span class="python_name">in_</span><span class="python_enclosure">(</span><span class="python_literal">'Mary'</span><span class="python_operator">, </span><span class="python_literal">'Susan'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># If you want to call an SQL function, use "func"
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">substr</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_number">2</span><span class="python_operator">, </span><span class="python_number">1</span><span class="python_enclosure">) </span><span class="python_operator">== </span><span class="python_literal">'a'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># You don't have to call select() on a table; it's got a bare form
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users</span><span class="python_enclosure">]</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Carl'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age</span><span class="python_enclosure">]</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Carl'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># This can be handy for things like count()
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)])</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_comment"># Here's how to do count(*)
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">(</span><span class="python_literal">"*"</span><span class="python_enclosure">)]</span><span class="python_operator">, </span><span class="python_name">from_obj</span><span class="python_operator">=</span><span class="python_enclosure">[</span><span class="python_name">users</span><span class="python_enclosure">])</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span></span></code></pre>

<p>Most of this should be pretty self-explanatory, and should give you an idea of
what's possible. A few notes:</p>

<pre><code><span class="python_comment"># Or you could use &amp;, | and ~ -- but watch out for priority!
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">((</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40</span><span class="python_enclosure">) </span><span class="python_operator">&amp; </span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">((</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40</span><span class="python_enclosure">) </span><span class="python_operator">| </span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_operator">~</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'Susan'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>In Python, the <code>&amp;</code> (and), <code>|</code> (or), and <code>~</code> (not) operators have a higher
priority than comparison operators like <code>==</code> and <code>!=</code>. So if you want to use
the <code>&amp;</code>, <code>|</code> and <code>~</code> operators, you have to be careful to wrap the other
clauses in parentheses. If you forget the parentheses, you'll be surprised by
the results:</p>

<pre><code><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_number">40 </span><span class="python_operator">&amp; </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>will be interpreted as:</p>

<pre><code><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">&lt; </span><span class="python_enclosure">(</span><span class="python_number">40 </span><span class="python_operator">&amp; </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">) </span><span class="python_operator">!= </span><span class="python_literal">'Mary'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>which will almost certainly not return the results you were expecting.</p>

<p>Finally, let's take a little bit of a closer look at the bare form of
<code>select()</code>:</p>

<pre><code><span class="python_comment"># You don't have to call select() on a table; it's got a bare form
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users</span><span class="python_enclosure">]</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Carl'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">age</span><span class="python_enclosure">]</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">!= </span><span class="python_literal">'Carl'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>Remember that the first argument to the bare form of <code>select()</code> is a list. If
you forget and pass it a table, you'll get a <code>TypeError</code> complaining about
iteration over a non-sequence.</p>

<pre><code><span class="python_comment"># This can be handy for things like count()
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)])</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>When there's a table involved in the <code>select()</code> call (e.g., when you're
counting the occurrences of a single column, such as <code>users.c.user_id</code>),
<code>select()</code> knows what to do. But if you're trying to do something like
a <code>COUNT(*)</code>, the <code>Select</code> object won't be able to guess which table you
want to select from unless you explicitly pass the <code>from_obj</code> parameter,
like so:</p>

<pre><code><span class="python_comment"># Here's how to do count(*)
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">(</span><span class="python_literal">"*"</span><span class="python_enclosure">)]</span><span class="python_operator">, </span><span class="python_name">from_obj</span><span class="python_operator">=</span><span class="python_enclosure">[</span><span class="python_name">users</span><span class="python_enclosure">])</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>Note that <code>from_obj</code> expects a list, just like the "what to select" parameter
does. Here, too, if you forget and pass a bare table, you'll get a <code>TypeError</code>
about iteration over a non-sequence.</p>

<h2>Joins</h2>

<p>At this point, you're probably wondering about using multiple tables in a
single <code>select()</code> statement. Wonder no more. Copy the following into
"<code>joindemo.py</code>":</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///joindemo.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">db</span><span class="python_operator">.</span><span class="python_name">echo </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_operator">
</span>
<span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">40</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'age'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">create</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">emails </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'emails'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'email_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'address'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">'users.user_id'</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">emails</span><span class="python_operator">.</span><span class="python_name">create</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">i </span><span class="python_operator">= </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">insert</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">(</span>
    <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Mary'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">30</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
    <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'John'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">42</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
    <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Susan'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">57</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
    <span class="python_enclosure">{</span><span class="python_literal">'name'</span><span class="python_operator">: </span><span class="python_literal">'Carl'</span><span class="python_operator">, </span><span class="python_literal">'age'</span><span class="python_operator">: </span><span class="python_number">33</span><span class="python_enclosure">}</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">i </span><span class="python_operator">= </span><span class="python_name">emails</span><span class="python_operator">.</span><span class="python_name">insert</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">i</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">(</span>
    <span class="python_comment"># There's a better way to do this, but we haven't gotten there yet</span>
    <span class="python_enclosure">{</span><span class="python_literal">'address'</span><span class="python_operator">: </span><span class="python_literal">'mary@example.com'</span><span class="python_operator">, </span><span class="python_literal">'user_id'</span><span class="python_operator">: </span><span class="python_number">1</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
    <span class="python_enclosure">{</span><span class="python_literal">'address'</span><span class="python_operator">: </span><span class="python_literal">'john@nowhere.net'</span><span class="python_operator">, </span><span class="python_literal">'user_id'</span><span class="python_operator">: </span><span class="python_number">2</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
    <span class="python_enclosure">{</span><span class="python_literal">'address'</span><span class="python_operator">: </span><span class="python_literal">'john@example.org'</span><span class="python_operator">, </span><span class="python_literal">'user_id'</span><span class="python_operator">: </span><span class="python_number">2</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
    <span class="python_enclosure">{</span><span class="python_literal">'address'</span><span class="python_operator">: </span><span class="python_literal">'carl@nospam.net'</span><span class="python_operator">, </span><span class="python_literal">'user_id'</span><span class="python_operator">: </span><span class="python_number">4</span><span class="python_enclosure">}</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_keyword">def </span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">stmt</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_name">rs </span><span class="python_operator">= </span><span class="python_name">stmt</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_keyword">for </span><span class="python_name">row </span><span class="python_keyword">in </span><span class="python_name">rs</span><span class="python_operator">:
        </span><span class="python_keyword">print </span><span class="python_name">row</span><span class="python_operator">
</span>
<span class="python_comment"># This will return more results than you are probably expecting.
</span><span class="python_operator"><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">])</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># The reason is because you specified no WHERE clause, so a full join was
# performed, which returns every possible combination of records from
# tables A and B. With an appropriate WHERE clause, you'll get the
# restricted record set you really wanted.
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">]</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id </span><span class="python_operator">== </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># If you're interested in only a few columns, then specify them explicitly
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">address</span><span class="python_enclosure">]</span><span class="python_operator">, </span>
           <span class="python_name">emails</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id </span><span class="python_operator">== </span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># There are also "smart" join objects that can figure out the correct join
# conditions based on the tables' foreign keys
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># If you want all the users, whether or not they have an email address,
# then you want an "outer" join.
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">outerjoin</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># Order of outer joins is important! Default is a "left outer join", which
# means "all records from the left-hand table, plus their corresponding
# values from the right-hand table, if any". Notice how this time, Susan's
# name will *not* appear in the results.
</span><span class="python_name">s </span><span class="python_operator">= </span><span class="python_name">outerjoin</span><span class="python_enclosure">(</span><span class="python_name">emails</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">run</span><span class="python_enclosure">(</span><span class="python_name">s</span><span class="python_enclosure">)</span><span class="python_operator">
</span></span></code></pre>

<p>That's enough for a taste. More information can be found in the
<a href="http://www.sqlalchemy.org/docs/sqlconstruction.myt">SQL Construction</a> section of the SQLAlchemy documentation. Now let's move
on to the really interesting part: mapping your data objects to SQL database
rows.</p>

<h2>Mapping your objects to SQL rows</h2>

<p>Now for the really interesting part: mapping your objects onto the database.</p>

<p>In other object-relational mappers such as SQLObject, the table definition
also doubles as the class whose instances are rows of data from the table.
SQLAlchemy, on the other hand, makes a strict distinction between the table
definition and the data class. You first create the table definition, then
create an (empty) class definition that will hold your data objects, and then
create a mapper that will map that class onto the database. It's perhaps
easier to show how this works than to explain it. Copy the following into
"<code>mapper1.py</code>":</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///joindemo.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">db</span><span class="python_operator">.</span><span class="python_name">echo </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_operator">
</span>
<span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">emails </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'emails'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># These are the empty classes that will become our data classes
</span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span><span class="python_keyword">class </span><span class="python_name">Email</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span>
<span class="python_operator"><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">mary </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">selectfirst</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'Mary'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mary</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">+= </span><span class="python_number">1</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">fred </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">fred</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_literal">'Fred'</span><span class="python_operator">
</span><span class="python_name">fred</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">= </span><span class="python_number">37</span><span class="python_operator">
</span>
<span class="python_keyword">print </span><span class="python_literal">"About to flush() without a save()..."</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()  </span><span class="python_comment"># Will *not* save Fred's data yet</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">fred</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">"Just called save(). Now flush() will actually do something."</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()  </span><span class="python_comment"># Now Fred's data will be saved</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">delete</span><span class="python_enclosure">(</span><span class="python_name">fred</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
</span></span></code></pre>

<p>Let's break this down piece-by-piece to see what's going on here.</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///joindemo.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">db</span><span class="python_operator">.</span><span class="python_name">echo </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_operator">
</span>
<span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>Here we're using the same SQLite database that we created in the join demo,
which contains users and email addresses. Unless you've deleted that file, the
data (four users and four email addresses) should still be there as well. We
set echo to True so that the SQL will be printed out at each step.</p>

<pre><code><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">emails </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'emails'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>Because the <code>users</code> and <code>emails</code> tables are already in the database, we don't
have to specify them again; we can just let SQLAlchemy fetch their definitions
from the database.</p>

<pre><code><span class="python_comment"># These are the empty classes that will become our data classes
</span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span><span class="python_keyword">class </span><span class="python_name">Email</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span></code></pre>

<p>Note that your data classes <em>must</em> be new-style classes (e.g., derived from
the base class <code>object</code>). If they aren't, SQLAlchemy will raise an
<code>ArgumentError</code> exception when you try to create the mapper. If you don't know
what the difference between new-style classes and old-style classes is, don't
worry about it; just get in the habit of deriving all your classes either from
<code>object</code> or from another base class that descends from <code>object</code>. Most of
Python's object-oriented features work much better on classes that ultimately
derive from <code>object</code>, and SQLAlchemy makes heavy use of those features.</p>

<p>Moving on:</p>

<pre><code><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>This is where all the magic happens. The <code>mapper()</code> function takes a minimum
of two parameters: first the data class to modify, and then the table object
onto which that data class should be mapped. The data class will have
attributes automatically added to it that correspond to the columns of your
database table. Thus, the User class now has <code>User.user_id</code>, <code>User.name</code>,
<code>User.age</code>, and <code>User.password</code>. The Email class now has <code>Email.email_id</code>,
<code>Email.address</code>, and <code>Email.user_id</code>.</p>

<pre><code><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">()</span><span class="python_operator">
</span></code></pre>

<p>SQLAlchemy is capable of automatically keeping track of the data objects you
create, and any changes you make to their attributes. This is done using
<code>Session</code> objects, which do a lot of the behind-the-scenes work for you.
Usually, you'll only need one <code>Session</code> object. SQLAlchemy could create it for
you, but there are times when you'll want to be able to access the <code>Session</code>
object directly. So SQLAlchemy follows the Python principle that "Explicit is
better than implicit" and requires you to create your own <code>Session</code> object. At
least, that's the default behavior: there are advanced features that let you
have a "default Session context", and sometimes that's exactly what you want.
However, it's best to learn the explicit way of doing things first; learning
the advanced features can wait until you're comfortable with SQLAlchemy's way
of doing things.</p>

<p><strong>New in 0.2</strong>: <code>Session</code> objects replace the <code>objectstore</code> object from
SQLAlchemy 0.1. The <code>objectstore.commit()</code> method (whose name was confusingly
similar to the <code>commit()</code> method of database transactions) has been replaced
by <code>session.flush()</code>. <code>Session</code> objects also have a couple of other
differences, which we'll get to in a moment.</p>

<pre><code><span class="python_name">mary </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">selectfirst</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'Mary'</span><span class="python_enclosure">)</span><span class="python_operator">
</span></code></pre>

<p>Now that we've created a <code>Session</code> object, we can use it to load some data
from our database. Now at first glance, the above line of code looks a little
overcomplicated. You might be wondering why it isn't something simpler, like
"<code>session.selectfirst(users.c.name=='Mary')</code>". The answer is that SQLAlchemy
needs to know what class you're trying to create instances of. Here it might
be possible to guess based on the fact that the <code>selectfirst()</code> criteria are
specifying a column from the <code>users</code> table. But there's a Python principle
that says, "In the face of ambiguity, refuse the temptation to guess." Because
what if that guess is wrong? What if you're trying to load all the email
addresses belonging to people named Mary? By forcing you to be explicit about
which data class you want, SQLAlchemy avoids the possibility of guessing
wrong.</p>

<p>Incidentally, the <code>session.query(YourClass)</code> call creates a <code>Query</code> object
that you could save and reuse later. This can save a lot of typing if you have
multiple <code>select()</code> calls to make.</p>

<p><strong>New in 0.2</strong>: In SQLAlchemy 0.1, you would have called <code>selectfirst()</code> on
the <code>usermapper</code> object. In SQLAlchemy 0.2, <code>select()</code> (and all related
functions such as <code>selectfirst()</code>) are called on <code>Query</code> objects instead.</p>

<pre><code><span class="python_name">mary</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">+= </span><span class="python_number">1</span><span class="python_operator">
</span></code></pre>

<p>Now that we have an instance of the data class (in the object "<code>mary</code>"), we
can manipulate its attributes just like a normal object. SQLAlchemy will keep
track of the changes we make, but won't actually send them to the database
right away. To send our changes to the database, we need to ...</p>

<pre><code><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
</span></code></pre>

<p>... call the <code>session.flush()</code> method. This will take all the changes we've
made to our data objects, and "flush" those changes out to the database.  If
we've made multiple changes, some of which depend on other changes (e.g.,
adding a new user and several email addresses for that user), SQLAlchemy is
smart enough to write the SQL statements in the correct order. SQLAlchemy also
wraps the entire set of SQL statements in a database transaction, as you'll
see if you examine the generated SQL code when you run this example.</p>

<p>If you want to control the database transactions yourself (maybe because you
want to accumulate several calls to <code>session.flush()</code> before committing the
transaction), you can. See the Transactions section, below, for details.</p>

<p><strong>New in 0.2</strong>: The <code>session.flush()</code> function used to be called
<code>objectstore.commit()</code>. The method name changed from <code>commit()</code> to <code>flush()</code>
in 0.2 because <code>commit()</code> sounded like what you do to a database transaction,
and it was causing some people to confuse SQLAlchemy sessions and database
transactions, which are two completely separate concepts.</p>

<pre><code><span class="python_name">fred </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">fred</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_literal">'Fred'</span><span class="python_operator">
</span><span class="python_name">fred</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">= </span><span class="python_number">37</span><span class="python_operator">
</span></code></pre>

<p>Here we're creating a new instance of our data class, <code>User</code>. This will
eventually result in a new database row once we call <code>session.flush()</code>.</p>

<pre><code><span class="python_keyword">print </span><span class="python_literal">"About to flush() without a save()..."</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()  </span><span class="python_comment"># Will *not* save Fred's data yet</span><span class="python_operator">
</span></code></pre>

<p>Look at the output from running this example. Notice that this
<code>session.flush()</code> call resulted in <em>no</em> database activity whatsoever, even
though we just created a new instance of our data class, which is supposed to
automatically create a new row in our database table. Why didn't
<code>session.flush()</code> do what it's supposed to do?</p>

<p>See if you can figure it out before proceeding to the next section. Hint:
remember that you're not necessarily limited to having only one <code>Session</code>
object around at any given time, and that "Explicit is better than implicit."</p>

<pre><code><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">fred</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_literal">"Just called save(). Now flush() will actually do something."</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()  </span><span class="python_comment"># Now Fred's data will be saved</span><span class="python_operator">
</span></code></pre>

<p>Now we see why the previous <code>session.flush()</code> call didn't actually save Fred's
data to the database. The <code>fred</code> object wasn't yet associated with any
<code>Session</code> objects! Explicit is better than implicit. By calling
<code>session.save(fred)</code>, we explicitly made <code>session</code> responsible for managing
the <code>fred</code> instance. From now on, any changes made to the <code>fred</code> instance will
be tracked by our <code>session</code> instance. That includes <code>fred</code>'s current state of
"instance has been created, but database row has not yet been created". Any
such "pending" objects will be flushed to the database at the next call to
<code>session.flush()</code>, as you can see from the output of running the example.</p>

<p>As was mentioned before, there are advanced features that let you have a
"default Session context". If you're using those features, then any
newly-created data instances (like our <code>fred</code> instance above) would be
automatically registered with the <code>Session</code> object from the current context,
and there'd be no need to call <code>session.save(fred)</code> -- and therefore, the
first <code>session.flush()</code> call in our above example would have created a new row
in the database.</p>

<p>However, it's usually best to learn the explicit way of doing things first;
learning the implicit way of doing things can wait until you're comfortable
with the explicit way. Then, when you hit the limits of the implicit way and
need to drop into "explicit mode" for a while, you won't be stepping outside
the limits of your comfort zone. It's much harder to go the other way around:
if you get too used to using implicit, default <code>Session</code> objects, then it will
be hard to remember how to use them explicitly. This can lead to mistakes like
calling <code>flush()</code> without calling <code>save()</code> first, followed by much
head-scratching as you try to figure out why the database doesn't contain
Fred's newly-created data.</p>

<p><strong>New in 0.2</strong>: SQLAlchemy 0.1 used implicit <code>Session</code> objects, so calling
<code>objectstore.commit()</code> after creating the <code>fred</code> instance would have run an
<code>INSERT</code> SQL statement. In SQLAlchemy 0.2, you need an explicit
<code>session.save()</code> call first, to associate the instance with one particular
session. Read the above three paragaphs for more details.</p>

<pre><code><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">delete</span><span class="python_enclosure">(</span><span class="python_name">fred</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
</span></code></pre>

<p>Now that we've looked at how to do <code>INSERT</code>s by creating new object instances,
let's look at how to do <code>DELETE</code>s. <code>DELETE</code>s, like <code>INSERT</code>s, are done by
calling a method on the <code>Session</code> object. Note that this does not delete the
<code>fred</code> instance from your own code, it just flags it as "deleted" in the
<code>Session</code> object's internal object tracker. The <code>fred</code> instance will still be
around, accessible to your own code, until you run a "<code>del fred</code>" statement.</p>

<p><strong>New in 0.2</strong>: In SQLAlchemy 0.1, the <code>delete()</code> method used to be called on
the data class or on the mapper. In SQLAlchemy 0.2, you call <code>delete()</code> on the
<code>Session</code> instance instead.</p>

<h2>Transactions</h2>

<p>If you want to control the database transactions yourself, instead of letting
SQLAlchemy do it for you, you can obtain a <code>Transaction</code> object by calling
<code>session.create_transaction()</code>. You can then call <code>commit()</code> or <code>rollback()</code>
on the <code>Transaction</code> object. This allows you to safely do things like the
following:</p>

<pre><code><span class="python_name">transaction </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">create_transaction</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">try</span><span class="python_operator">: 
    </span><span class="python_comment"># Do some work here that might fail
</span><span class="python_operator">    </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_comment"># Do some more work here that might fail
    </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_comment"># Success, commit everything
    </span><span class="python_name">transaction</span><span class="python_operator">.</span><span class="python_name">commit</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">except</span><span class="python_operator">:
    </span><span class="python_comment"># Make sure the transaction is rolled back ...
</span><span class="python_operator">    </span><span class="python_name">transaction</span><span class="python_operator">.</span><span class="python_name">rollback</span><span class="python_enclosure">()</span><span class="python_operator">
    </span><span class="python_comment"># ... then propagate the error upwards to be handled elsewhere
    </span><span class="python_keyword">raise</span><span class="python_operator">
</span></code></pre>

<h2>Data mapping, continued</h2>

<p>Remember how, in the <code>joindemo.py</code> tutorial, one of the comments said:</p>

<pre><code><span class="python_comment"># There's a better way to do this, but we haven't gotten there yet
</span><span class="python_operator"></span></code></pre>

<p>Well, now's the time to look at the better way to handle one-to-many and
many-to-many relations. Copy the following into "<code>mapper2.py</code>":</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///joindemo.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">db</span><span class="python_operator">.</span><span class="python_name">echo </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_operator">
</span><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">emails </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'emails'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span><span class="python_name">autoload</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># Let's give our User and Email classes a little more smarts
</span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">age</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">= </span><span class="python_name">name</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">age </span><span class="python_operator">= </span><span class="python_name">age</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">
</span><span class="python_keyword">class </span><span class="python_name">Email</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">address</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">address </span><span class="python_operator">= </span><span class="python_name">address</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">address</span><span class="python_operator">
</span>
<span class="python_comment"># Here we look at several alternate ways to do the same thing. Try
# running this program multiple times, enabling a different one of
# these code blocks each time.
</span>
<span class="python_comment"># Let's look at several ways to do one-to-many relationships.
</span>
<span class="python_comment"># We create the Email mapper first...
</span><span class="python_operator"><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_comment"># ... so that we can use it in the User mapper
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">emailmapper</span><span class="python_enclosure">)</span><span class="python_operator">,  </span><span class="python_comment"># Here's where the magic happens</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span><span class="python_name">mary </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'Mary'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">mary</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">
</span>
<span class="python_comment"># If we try to create multiple mappers associated with a single data
# class, we have to specify which one is the "primary" mapper associated
# with the class. Since we're demonstrating how to create one-to-many
# relationships in multiple different ways, it's simplest to just clear
# all the mappers and start over.
</span><span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># We could also use the data class instead of the mapper as the parameter
# to relation()
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span><span class="python_name">mary </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'Mary'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">mary</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">
</span>
<span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># In fact, we don't really need to keep a reference to the mapper object
# around at all. Under most circumstances, we can just throw away the
# object returned by mapper(). SQLAlchemy keeps track of a data class's
# primary mapper behind the scenes, so we don't need to hold a reference
# to it.
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span><span class="python_name">mary </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'Mary'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">mary</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">
</span>
<span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># Notice that the order in which you create the mappers can be important.
# If you want to call relation(), you need to pass it a class that's
# already been mapped to a database table, or else SQLAlchemy won't be
# able to figure out which table the ForeignKey relationships should refer
# to. (Remember: "In the face of ambiguity, refuse the temptation to guess.")
</span><span class="python_keyword">try</span><span class="python_operator">:
    </span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
        <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_enclosure">})</span><span class="python_operator">
</span><span class="python_keyword">except </span><span class="python_name">exceptions</span><span class="python_operator">.</span><span class="python_name">InvalidRequestError</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_literal">"Ignoring the deliberately-provoked error and moving on..."</span><span class="python_operator">
</span>
<span class="python_operator"><span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># What if we also want a "user" property on the Email class? Here's one
# way to do it.
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)  </span><span class="python_comment"># Save the mapper, to use it later</span><span class="python_operator">
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span><span class="python_comment"># Now that the User mapper has been created, we can use it in a call
# to relation()
</span><span class="python_name">emailmapper</span><span class="python_operator">.</span><span class="python_name">add_property</span><span class="python_enclosure">(</span><span class="python_literal">'user'</span><span class="python_operator">, </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">john </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'John'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">john</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">
</span><span class="python_name">carl_address </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">address</span><span class="python_operator">=</span><span class="python_literal">'carl@nospam.net'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">carl_address</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">
</span>
<span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># There's a handy "backref" feature that will do the above for you
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'user'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span><span class="python_comment"># No need to call add_property(), it's already been done
</span><span class="python_name">john </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'John'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">john</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">
</span><span class="python_name">carl_address </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">address</span><span class="python_operator">=</span><span class="python_literal">'carl@nospam.net'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">carl_address</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">
</span>
<span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># Order doesn't actually matter when you use backref: you can create the
# "one" side of the one-to-many relationship first, or the "many" side of
# the one-to-many relationship first, whichever way seems more natural
# to you.
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'user'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'emails'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span><span class="python_name">john </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'John'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">john</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">
</span><span class="python_name">carl_address </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">address</span><span class="python_operator">=</span><span class="python_literal">'carl@nospam.net'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">carl_address</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">
</span>
<span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># If you've created a relation(), you can now use object references
# instead of object ID's to manage the relationship, and it all works
# just like you'd expect it to work.
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'user'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span>
<span class="python_name">harry </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'Harry'</span><span class="python_operator">, </span><span class="python_name">age</span><span class="python_operator">=</span><span class="python_number">47</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">em1 </span><span class="python_operator">= </span><span class="python_name">Email</span><span class="python_enclosure">(</span><span class="python_literal">'harry@nowhere.com'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">em2 </span><span class="python_operator">= </span><span class="python_name">Email</span><span class="python_enclosure">(</span><span class="python_literal">'harry@example.org'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">em1</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">harry  </span><span class="python_comment"># Properly updates the harry.emails property</span><span class="python_operator">
</span><span class="python_name">harry</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">em2</span><span class="python_enclosure">)  </span><span class="python_comment"># Properly sets em2.user</span><span class="python_operator">
</span><span class="python_comment"># Let's prove that harry.emails and em2.user were properly set
</span><span class="python_keyword">print </span><span class="python_name">em2</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">harry</span><span class="python_operator">.</span><span class="python_name">emails</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">harry</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">clear_mappers</span><span class="python_enclosure">()</span><span class="python_operator">
</span>

<span class="python_comment"># Finally, let's demonstrate some other clever features
</span><span class="python_name">emailmapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">emails</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'emails'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'user'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span>
<span class="python_comment"># If a relation has been defined, then get_by and select_by calls
# can do the correct joins automatically
</span><span class="python_keyword">print </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get_by</span><span class="python_enclosure">(</span><span class="python_name">address</span><span class="python_operator">=</span><span class="python_literal">'mary@example.com'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">age</span><span class="python_operator">=</span><span class="python_number">42</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_comment"># This will only work if the column you're looking for is *not*
# present in the "original" class, but is present in one of its
# relations. For example, the following does *not* do a join to the
# User table, but gets the user_id value from the Email table. Notice
# the difference in the SQL that's printed.
</span><span class="python_keyword">print </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Email</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select_by</span><span class="python_enclosure">(</span><span class="python_name">user_id</span><span class="python_operator">=</span><span class="python_number">2</span><span class="python_enclosure">)</span><span class="python_operator">
</span></span></span></code></pre>

<p>Most of this is pretty self-explanatory. The <code>relation()</code> function is where
all the magic happens. As you can see from the above example, it creates a
property on the data class which will act like a list or a single object, as
appropriate. When you're in the <code>User</code> class, reading the <code>emails</code> property,
you're looking from the "one" side to the "many" side of the one-to-many
relationship, so the property acts like a list. When you're in the <code>Email</code>
class and reading the <code>user</code> property, you're looking from the "many" side to
the "one" side of the relationship, so the property acts like a reference to
a single object. The property has both getter and setter methods, so you can
run code like "<code>em1.user = harry</code>" and the correct things will happen.</p>

<p>A quick note on the <code>get_by()</code> and <code>select_by()</code> functions we're using above.
These are shorthand functions that take keyword arguments referring to the
columns in the table we're selecting from. This lets you write
"<code>get_by(name='Mary')</code>" instead of "<code>selectfirst(users.c.name=='Mary')</code>". If
you specify multiple keyword arguments, they'll be joined together with AND.
However, keep in mind a pretty severe limitation of the <code>get_by()</code> and
<code>select_by()</code> functions, that comes directly from their use of Python keyword
arguments. Keyword arguments are always in the form "<code>name=value</code>", which
means that if you want to do anything other than an equality comparison, you
need to use the full column name. E.g., "<code>get_by(age&lt;=39)</code>" won't work; you
need to do "<code>selectfirst(users.c.name &lt;= 39)</code>" instead.</p>

<p>One final note: notice that in the penultimate example, when we created a new
user Harry with two email addresses, we didn't call <code>em1.save()</code> or
<code>em2.save()</code>. And yet both <code>Email</code> instances were also saved. This
demonstrates how SQLAlchemy tracks object dependencies for you. The
newly-created <code>User</code> instance held two references to <code>Email</code> instances in its
<code>emails</code> property; therefore, the <code>Email</code> instances were dependent on their
"parent" object (the <code>User</code> instance) and needed to be written out to the
database at the same time. Notice also that the User object was created first,
then the two dependent Email objects. That's because they needed to know the
user<em>id for Harry's newly-created database row, in order to set their own
user</em>id values properly. SQLAlchemy is very smart about dependency tracking,
and will generally figure out the right order in which to do things. And if
you have a very complicated example that SQLAlchemy can't figure out
correctly, the author of SQLAlchemy considers that a bug and asks that you
report it on the SQLAlchemy mailing list.</p>

<p><strong>New in 0.2</strong>: As in the <code>selectdemo.py</code> example, we call <code>select()</code>
functions on the <code>Session</code> object instead of on the mapper, via
<code>session.query(DataClass)</code>. That means that we often don't need to keep a
reference to the mapper around, and makes it possible to simply throw away
the results of the <code>mapper()</code> function call. It also means that the
<code>assign_mapper()</code> function is less useful, so <code>assign_mapper()</code> isn't covered
in this version of the tutorial.</p>

<h2>Data mapping, part three: many-to-many relationships</h2>

<p>There's one more item to cover. We've looked at one-to-many relationships, but
we also need to look at many-to-many relationships. As you probably know
already, many-to-many relationships in databases are handled by a third table
that holds information about the relation. E.g., if you have an "<code>articles</code>"
table and a "<code>keywords</code>" table, and you want to be able to associate keywords
with articles, you'd need a many-to-many relationship. One-to-many wouldn't
work, because one article might need to be tagged with several different
keywords, and the same keyword might be used to tag several articles; so this
is a classic many-to-many relationship. Thus, you'd use a third table with
just two columns, "<code>article_id</code>" and "<code>keyword_id</code>", to keep track of the
associations. By convention, such a table is usually named with the names of
the two tables it references, separated by an underscore. Thus, the table
structure in the following example (call it "<code>manytomany.py</code>"):</p>

<pre><code><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span><span class="python_name">db </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///keywords.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">db</span><span class="python_operator">.</span><span class="python_name">echo </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_operator">
</span><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">BoundMetaData</span><span class="python_enclosure">(</span><span class="python_name">db</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">articles </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'articles'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'headline'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">150</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'body'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">keywords </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'keywords'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">50</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">association </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'articles_keywords'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">'articles.article_id'</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">'keywords.keyword_id'</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># Handy feature: create all the tables with one function call
</span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_keyword">class </span><span class="python_name">Article</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">headline</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_operator">, </span><span class="python_name">body</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">headline </span><span class="python_operator">= </span><span class="python_name">headline</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">body </span><span class="python_operator">= </span><span class="python_name">body</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_literal">'Article %d: "%s"' </span><span class="python_operator">% </span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">article_id</span><span class="python_operator">, </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">headline</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_operator"><span class="python_keyword">class </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_name">None</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">keyword_name </span><span class="python_operator">= </span><span class="python_name">name</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">keyword_name</span><span class="python_operator">
</span>
<span class="python_comment"># To create a many-to-many relation, specify the association table as
# the "secondary" keyword parameter to mapper()
</span><span class="python_operator"><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_operator">, </span><span class="python_name">articles</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">keywords</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
    <span class="python_literal">'articles'</span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_operator">, </span><span class="python_name">secondary</span><span class="python_operator">=</span><span class="python_name">association</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'keywords'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span>
<span class="python_name">a1 </span><span class="python_operator">= </span><span class="python_name">Article</span><span class="python_enclosure">(</span><span class="python_name">headline</span><span class="python_operator">=</span><span class="python_literal">"Python is cool!"</span><span class="python_operator">, </span><span class="python_name">body</span><span class="python_operator">=</span><span class="python_literal">"(to be written)"</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">a2 </span><span class="python_operator">= </span><span class="python_name">Article</span><span class="python_enclosure">(</span><span class="python_name">headline</span><span class="python_operator">=</span><span class="python_literal">"SQLAlchemy Tutorial"</span><span class="python_operator">, </span><span class="python_name">body</span><span class="python_operator">=</span><span class="python_literal">"You're reading it"</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">a1</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">a2</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">k_tutorial </span><span class="python_operator">= </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'tutorial'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">k_cool </span><span class="python_operator">= </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'cool'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">k_unfinished </span><span class="python_operator">= </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'unfinished'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">a1</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">k_unfinished</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">k_cool</span><span class="python_operator">.</span><span class="python_name">articles</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">a1</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">k_cool</span><span class="python_operator">.</span><span class="python_name">articles</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">a2</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_comment"># Or:
</span><span class="python_name">k_cool</span><span class="python_operator">.</span><span class="python_name">articles </span><span class="python_operator">= </span><span class="python_enclosure">[</span><span class="python_name">a1</span><span class="python_operator">, </span><span class="python_name">a2</span><span class="python_enclosure">]  </span><span class="python_comment"># This works as well!</span><span class="python_operator">
</span><span class="python_name">a2</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">k_tutorial</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># Now we write all this out to the database in one single step, and
# SQLAlchemy automatically figures out the correct order for the SQL
# statements. Notice also how we didn't need to save the Keyword
# instances, because a dependency relationship was set up when we
# associated them with their articles just now.
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_keyword">print </span><span class="python_name">a1</span><span class="python_operator">, </span><span class="python_name">a1</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">a2</span><span class="python_operator">, </span><span class="python_name">a2</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">k_tutorial</span><span class="python_operator">, </span><span class="python_name">k_tutorial</span><span class="python_operator">.</span><span class="python_name">articles</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">k_cool</span><span class="python_operator">, </span><span class="python_name">k_cool</span><span class="python_operator">.</span><span class="python_name">articles</span><span class="python_operator">
</span><span class="python_keyword">print </span><span class="python_name">k_unfinished</span><span class="python_operator">, </span><span class="python_name">k_unfinished</span><span class="python_operator">.</span><span class="python_name">articles</span><span class="python_operator">
</span></span></span></code></pre>

<p>Again, the code pretty much speaks for itself. If you pass the association
table as the second parameter to <code>mapping()</code>, and SQLAlchemy sees that it's in
the correct format (it has only two columns, each of which is a foreign key to
one of the tables involved in the relation), it will automatically set up a
many-to-many relationship for you.</p>

<p>One thing you may be interested in is the handy <code>metadata.create_all()</code>
method. It will automatically figure out the dependency relationships between
your tables, and create them in the proper order. It will also detect if the
tables have already been created, and not try to re-create them a second time.</p>

<p>If you want to hold more data in the association object (for example, maybe
you want to record the exact date and time when the article was tagged with
any given keyword), it's slightly more complicated. The SQLAlchemy
documentation has a good explanation of the process at the bottom of the
<a href="http://www.sqlalchemy.org/docs/datamapping.myt">Data Mapping</a> page. That whole page, in fact, is well worth reading, since
there are several other features of data mapping that I glossed over or left
out entirely, in order to keep the size of this tutorial manageable. And once
you've grasped those concepts, you can move on to the <a href="http://www.sqlalchemy.org/docs/adv_datamapping.myt">Advanced Data Mapping</a>
section, which covers subjects like mapping a table onto itself (useful for
tracking manager/subordinate relationships in an Employees table, for
example).</p>

<p><strong>New in 0.2</strong>: The <code>create_all()</code> function is new. Notice also that you need
to explicitly <code>save()</code> the newly-created <code>Article</code> objects so that
<code>session.flush()</code> will flush them to the database.</p>

<h2>Conclusion</h2>

<p>Hopefully this has given you a taste of what using SQLAlchemy feels like. The
examples in this tutorial should be enough to give you a head start in writing
your own applications. When you need more advanced features beyond what we've
covered here, check out the extensive <a href="http://www.sqlalchemy.org/docs/index.myt">SQLAlchemy documentation</a>. Just about
everything you'll need is there; and if you still don't find what you're
looking for, join the <a href="http://www.sqlalchemy.org/community.myt">SQLAlchemy mailing list</a> and ask!</p>

</body></html>